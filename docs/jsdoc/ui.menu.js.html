<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ui.menu.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ui.menu.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Copyright, 2020, Gabriel Quagliano. Bajo licencia Apache 2.0.
 * 
 * @author Gabriel Quagliano - gabriel.quagliano@gmail.com
 * @version 1.0
 */

/**
 * Métodos anexados a la gestión de la interfaz.
 */
(function() {
    "use strict";

    var menuAbierto=[];

    var abrirElementoMenu=function(elem) {
        //Evento DOM para que otros objetos de los cuales dependa el menú puedan detectar el cierre
        elem.ejecutarEvento("menu-abierto");

        ui.animarAparecer(elem);
                
        //Reposicionar si se sale de pantalla

        elem.removerClase(/^desplegar-(izquierda|arriba)/);

        var margen=15,
            posicionamiento=elem.estilo("position"),
            pos=elem.posicionAbsoluta(),
            ancho=elem.ancho(),
            alto=elem.alto(),
            anchoVentana=elem.ownerDocument.defaultView.ancho(), //Puede estar dentro de un marco (no usar window)
            altoVentana=elem.ownerDocument.defaultView.alto(),   //Puede estar dentro de un marco (no usar window)
            excedeX=pos.x+ancho>anchoVentana-margen,
            excedeY=pos.y+alto>altoVentana-margen;
        
        if(excedeX||excedeY) {
            if(posicionamiento=="absolute"||posicionamiento=="relative") {
                //En este caso utilizaremos clases CSS para que se pueda reposicionar de acuerdo a los estilos específicos del padre
                if(excedeX) elem.agregarClase("desplegar-izquierda");
                if(excedeY) elem.agregarClase("desplegar-arriba");
            } else {
                //Por defecto, se comporta como fixed
                if(excedeX) elem.estilos({ left:anchoVentana-ancho-margen });
                if(excedeY) elem.estilos({ top:altoVentana-alto-margen });
            } 
        }
    };
    
    var cerrarElementoMenu=function(elem,omitirAnimacion,eliminar) {
        var fn=function() {
            if(eliminar) elem.remover();
        };

        if(omitirAnimacion) {
            ui.detenerAnimacion(elem);
            elem.agregarClase("oculto");
            fn();
        } else {
            ui.animarDesaparecer(elem,fn);
        }

        //Evento DOM para que otros objetos de los cuales dependa el menú puedan detectar el cierre
        elem.ejecutarEvento("menu-cerrado");
    };

    /**
     * Construye un menú.
     * @param {Object[]} items - Items del menú.
     * @param {string} items[].etiqueta - Etiqueta.
     * @param {function} [items[].accion] - Función a ejecutar al seleccionarse la opción.
     * @param {(function|boolean)} [items[].habilitado=true] - Estado del item o función a ejecutar para determinar si el item se encuentra habilitado.
     * @param {boolean} [items[].separador=false] - Determina si el item es seguido de un separador.
     * @param {Object[]} [items[].submenu] - Items del submenú (admiten las mismas propiedades que items).
     * @param {string} [clase] - Clase CSS.
     * @returns {Object}
     */
    ui.construirMenu=function(items,clase) {
        if(typeof clase==="undefined") clase=null;

        //TODO Integración con Cordova
        //TODO Integración con el cliente de escritorio

        var click=function(item,ev) {
            if(item.hasOwnProperty("accion")) {
                ev.preventDefault();
                ev.stopPropagation();
                item.accion();
            } else if(item.hasOwnProperty("elemSubmenu")) {
                //Detener click si tiene submenú
                ev.preventDefault();
                ev.stopPropagation();
                return;
            }
            ui.cerrarMenu();
        },
        toque=function(item,ev) {
            if(item.hasOwnProperty("elemSubmenu")) {
                abrirSubmenu(item);
                ev.preventDefault();
                ev.stopPropagation();
            } else {
                click(item,ev);
            }
        },
        abrirSubmenu=function(item) {
            //TODO Posicionamiento según el espacio disponible
            if(!item.hasOwnProperty("elemSubmenu")) return;
            abrirElementoMenu(item.elemSubmenu);
        },
        cerrarSubmenu=function(item) {
            if(!item.hasOwnProperty("elemSubmenu")) return;
            cerrarElementoMenu(item.elemSubmenu);
        };

        var fn=function(ul,items) {
            for(var i=0;i&lt;items.length;i++) {
                var li=document.crear("&lt;li>"),
                    a=document.crear("&lt;a href='#'>");

                a.establecerHtml(items[i].etiqueta);

                if(items[i].hasOwnProperty("submenu")) {
                    var ulSubmenu=document.crear("&lt;ul class='foxtrot-submenu oculto'>");
                    fn(ulSubmenu,items[i].submenu);

                    li.agregarClase("con-submenu");
                    li.anexar(ulSubmenu);
                    items[i].elemSubmenu=ulSubmenu;
                }

                if(items[i].hasOwnProperty("separador")&amp;&amp;items[i].separador) li.agregarClase("foxtrot-menu-separador");

                li.anexar(a);
                ul.anexar(li);
                
                items[i].elem=li;
                items[i].elemA=a;

                //Eventos

                a.evento("click",function(item) {
                    return function(ev) {
                        click(item,ev);
                    };
                }(items[i]))
                .evento("touchstart",function(item) {
                    return function(ev) {
                        toque(item,ev);
                    };
                }(items[i]));

                li.evento("mouseenter",function(item) {
                    return function() {
                        abrirSubmenu(item);
                    };
                }(items[i]))
                .evento("mouseleave",function(item) {
                    return function() {
                        cerrarSubmenu(item);
                    };
                }(items[i]));
            }
        };

        var menu={
            elem:document.crear("&lt;ul class='foxtrot-menu oculto'>"),
            items:items.clonar(),
            eliminar:false
        };

        if(clase) menu.elem.agregarClase(clase);

        fn(menu.elem,menu.items);

        ui.obtenerDocumento().body.anexar(menu.elem);

        return menu;
    };

    /**
     * Actualiza el estado de los items del menú.
     * @param {Object} menu - Menú generado con ui.construirMenu().
     * @returns {ui}
     */
    ui.actualizarMenu=function(menu) {
        var fn=function(items) {
            for(var i=0;i&lt;items.length;i++) {
                if(items[i].hasOwnProperty("habilitado")) {
                    var v=items[i].habilitado;
                    if(typeof v==="function") v=v();
                    if(v) items[i].elem.removerClase("deshabilitado");
                    else items[i].elem.agregarClase("deshabilitado");
                }
                
                if(items[i].hasOwnProperty("submenu")) fn(items[i].submenu);
            }
        };

        fn(menu.items);

        return ui;
    };

    var menuKeyDn=function(ev) {
        var eventoValido=true;
        if(ev.which==27) {
            //ESC
            ui.cerrarMenu();
        } else if(ev.which==40) {
            //Abajo
            //TODO
        } else if(ev.which==84) {
            //Arriba
            //TODO
        } else if(ev.which==13) {
            //Enter
            //TODO
        } else {
            eventoValido=false;
        }
        if(eventoValido) {
            ev.preventDefault();
            ev.stopPropagation();
        }
    };

    var menuMouseUp=function(ev) {
        ui.cerrarMenu();
    };

    var menuBlur=function(ev) {
        ui.cerrarMenu();
    };

    var removerEventosMenu=function() {
        ui.obtenerDocumento().removerEvento("keydown",menuKeyDn)
            .removerEvento("mouseup",menuMouseUp);
        window.removerEvento("blur",menuBlur);

        var marco=ui.obtenerMarco();
        if(marco) marco.contentWindow.removerEvento("blur",menuBlur);
    };

    /**
     * Devuelve los menú actualmente abiertos.
     * @returns {Object[]}
     */
    ui.obtenerMenuAbierto=function() {
        return menuAbierto;
    };

    /**
     * Abre un menú.
     * @param {(Object[]|Object)} obj - Array de items de menú, un menú generado con ui.construirMenu() o cualquier elemento del DOM compatible.
     * @param {(Node|Element|Object)} [posicion] - Si se especifica un elemento del DOM, se posicionará el menú sobre el mismo; en caso contrario, debe especificarse un objeto con las propiedades {x,y}.
     * @param {string} [clase] - Clase CSS.
     * @returns {ui}
     */
    ui.abrirMenu=function(obj,posicion,clase) {
        if(typeof posicion==="undefined") posicion=null;
        if(typeof clase==="undefined") clase=null;

        //TODO Integración con Cordova
        //TODO Integración con el cliente de escritorio

        if(util.esArray(obj)) {
            obj=ui.construirMenu(obj,clase);
            obj.eliminar=true;
        }

        var elem;
        if(util.esElemento(obj)) {
            elem=obj;
        } else {
            elem=obj.elem;
            ui.actualizarMenu(obj);
        }

        menuAbierto.push(obj);

        //Posición

        if(posicion) {
            var x,y;
            if(util.esElemento(posicion)) {
                var pos=posicion.posicionAbsoluta(),
                    alto=posicion.alto();
                x=pos.x;
                y=pos.y+alto;
            } else {
                x=posicion.x;
                y=posicion.y;
            }

            elem.estilos({
                    left:x,
                    top:y
                });
        }        

        abrirElementoMenu(elem);

        //Eventos

        ui.obtenerDocumento().evento("keydown",menuKeyDn)
            .evento("mouseup",menuMouseUp);
            
        window.evento("blur",menuBlur);

        var marco=ui.obtenerMarco();
        if(marco) marco.contentWindow.evento("blur",menuBlur);

        return ui;
    };

    /**
     * Cierra el menú especificado, o todos los menús abiertos si se omite el primer parámetro.
     * @param {Object} [menu] - Menú a cerrar (objeto generado con ui.construirMenu o cualquier elemento del DOM compatible).
     * @param {boolean} [omitirAnimacion=false] - Cierra el menú inmediatamente, sin animaciones.
     * @returns {ui}
     */
    ui.cerrarMenu=function(menu,omitirAnimacion) {
        if(typeof omitirAnimacion==="undefined") omitirAnimacion=false;

        if(typeof menu==="undefined"||!menu) {
            //Se debe crear una copia de menuAbierto para trabajar ya que ui.cerrarMenu() lo alterará
            menuAbierto.clonar().forEach(function(m) {
                ui.cerrarMenu(m,omitirAnimacion);
            });
            return ui;
        }

        var elem=util.esElemento(menu)?menu:menu.elem; //Si no es un elemento del DOM, se asume un objeto menú
        cerrarElementoMenu(elem,omitirAnimacion,menu.eliminar);

        removerEventosMenu();
        
        menuAbierto.splice(menuAbierto.indexOf(menu),1);

        return ui;
    };
})();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Externals</h3><ul><li><a href="external-EventTarget.html">EventTarget</a></li><li><a href="external-HTMLDocument.html">HTMLDocument</a></li><li><a href="external-Node.html">Node</a></li><li><a href="external-NodeList.html">NodeList</a></li><li><a href="external-Object.html">Object</a></li><li><a href="external-Window.html">Window</a></li></ul><h3>Classes</h3><ul><li><a href="ajax.html">ajax</a></li><li><a href="aplicacion.html">aplicacion</a></li><li><a href="componente.html">componente</a></li><li><a href="componenteAgenda.html">componenteAgenda</a></li><li><a href="componenteAlternar.html">componenteAlternar</a></li><li><a href="componenteArbol.html">componenteArbol</a></li><li><a href="componenteArchivo.html">componenteArchivo</a></li><li><a href="componenteBoton.html">componenteBoton</a></li><li><a href="componenteBucle.html">componenteBucle</a></li><li><a href="componenteBuscador.html">componenteBuscador</a></li><li><a href="componenteCampo.html">componenteCampo</a></li><li><a href="componenteCheckbox.html">componenteCheckbox</a></li><li><a href="componenteCodigo.html">componenteCodigo</a></li><li><a href="componenteColumna.html">componenteColumna</a></li><li><a href="componenteColumnaTabla.html">componenteColumnaTabla</a></li><li><a href="componenteCondicional.html">componenteCondicional</a></li><li><a href="componenteContenedor.html">componenteContenedor</a></li><li><a href="componenteContenedorMenu.html">componenteContenedorMenu</a></li><li><a href="componenteDeslizable.html">componenteDeslizable</a></li><li><a href="componenteDesplegable.html">componenteDesplegable</a></li><li><a href="componenteDialogo.html">componenteDialogo</a></li><li><a href="componenteEspaciador.html">componenteEspaciador</a></li><li><a href="componenteEtiqueta.html">componenteEtiqueta</a></li><li><a href="componenteFecha.html">componenteFecha</a></li><li><a href="componenteFila.html">componenteFila</a></li><li><a href="componenteFilaTabla.html">componenteFilaTabla</a></li><li><a href="componenteFormulario.html">componenteFormulario</a></li><li><a href="componenteGrupoOpciones.html">componenteGrupoOpciones</a></li><li><a href="componenteHora.html">componenteHora</a></li><li><a href="componenteIcono.html">componenteIcono</a></li><li><a href="componenteImagen.html">componenteImagen</a></li><li><a href="componenteImportar.html">componenteImportar</a></li><li><a href="componenteItemMenu.html">componenteItemMenu</a></li><li><a href="componenteMenu.html">componenteMenu</a></li><li><a href="componenteNavegacion.html">componenteNavegacion</a></li><li><a href="componentePestana.html">componentePestana</a></li><li><a href="componentePestanas.html">componentePestanas</a></li><li><a href="componenteTabla.html">componenteTabla</a></li><li><a href="componenteTexto.html">componenteTexto</a></li><li><a href="componenteVista.html">componenteVista</a></li><li><a href="controlador.html">controlador</a></li><li><a href="editable.html">editable</a></li><li><a href="enrutador.html">enrutador</a></li><li><a href="enrutadorPredeterminado.html">enrutadorPredeterminado</a></li><li><a href="expresion.html">expresion</a></li><li><a href="servidor.html">servidor</a></li><li><a href="ui.html">ui</a></li><li><a href="util.html">util</a></li></ul><h3>Global</h3><ul><li><a href="global.html#componentes">componentes</a></li><li><a href="global.html#configComponente">configComponente</a></li><li><a href="global.html#controladores">controladores</a></li><li><a href="global.html#cuerpo">cuerpo</a></li><li><a href="global.html#documento">documento</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Mon Sep 14 2020 22:59:29 GMT-0300 (GMT-03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
