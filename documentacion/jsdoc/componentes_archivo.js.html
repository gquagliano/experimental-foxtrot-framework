<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: componentes/archivo.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: componentes/archivo.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Copyright, 2020, Gabriel Quagliano. Bajo licencia Apache 2.0.
 * 
 * @author Gabriel Quagliano - gabriel.quagliano@gmail.com
 * @version 1.0
 */

 "use strict";

/**
 * @class Componente concreto Campo de carga de archivo.
 */
var componenteArchivo=function() {    
    this.componente="archivo";

    this.etiqueta=null;
    this.barra=null;
    this.archivos=[];
    this.ajax=null;
    this.subidaEnCurso=false;

    /**
     * Propiedades de Campo.
     */
    this.propiedadesConcretas={
        "Archivo":{
            multiple:{
                etiqueta:"Múltiple",
                tipo:"bool",
                adaptativa:false
            },
            acepta:{
                etiqueta:"Acepta",
                adaptativa:false
            },
            multimedia:{
                etiqueta:"Multimedia",
                tipo:"opciones",
                opciones:{
                    audio:"Audio",
                    video:"Video",
                    videoFrontal:"Video (cámara frontal)",
                    foto:"Foto",
                    fotoFrontal:"Foto (cámara frontal)"
                },
                adaptativa:false
            },
            subirInmediatamente:{
                etiqueta:"Subir inmediatamente",
                tipo:"bool",
                adaptativa:false
            }
        },
        "Eventos":{
            listo:{
                etiqueta:"Archivos listos",
                adaptativa:false,
                evento:true
            }
        }
    };

    /**
     * Inicializa la instancia tras ser creada o restaurada.
     */
    this.inicializar=function() {
        if(this.fueInicializado) return this; 

        this.campo=this.elemento.querySelector("input");
        this.etiqueta=this.elemento.querySelector("label");

        this.inicializarComponente();
        return this;
    };

    /**
     * Crea el elemento del DOM para esta instancia.
     */
    this.crear=function() {
        this.elemento=document.crear("&lt;div class='custom-file'>");

        this.campo=document.crear("&lt;input type='file' class='custom-file-input'>");
        this.elemento.anexar(this.campo);

        this.etiqueta=document.crear("&lt;label class='custom-file-label'>");
        this.elemento.anexar(this.etiqueta);

        this.crearComponente();
        return this;
    };

    /**
     * Establece los eventos predeterminados.
     */
    this.establecerEventos=function() {
        var t=this;

        this.campo.removerEventos();
        
        this.campo.evento("change",function(ev) {
            t.abortar()
                .procesarArchivos()
                .procesarEvento("change","modificacion","modificacion",ev,null);

            var subir=this.propiedad("subirInmediatamente");
            if(typeof subir==="undefined"||subir===null||subir===true) { //por defecto, true
                t.subirArchivos();
            }
        });

        return this;
    };

    /**
     * Reestablece el componente al finalizar la carga.
     */
    var finalizarSubida=(function() {
        this.subidaEnCurso=false;
        if(this.barra) this.barra.remover();
        this.barra=null;
    }).bind(this);

    /**
     * Aborta la carga en curso.
     * @returns {componente}
     */
    this.abortar=function() {
        if(this.ajax) this.ajax.abortar();
        finalizarSubida();
        return this;
    };

    /**
     * Envía los archivos seleccionados al servidor.
     * @returns {componente}
     */
    this.subirArchivos=function() {
        if(!this.archivos.length) return this;

        this.subidaEnCurso=true;

        var params={};
        this.archivos.forEach(function(archivo,i) {
            params["archivo-"+i]=archivo.nativo;
        });

        this.barra=document.crear("&lt;span class='progreso'>&lt;span class='progreso-barra'>&lt;/span>&lt;/span>");
        this.barra.anexarA(this.elemento);
        
        var t=this;
        this.ajax=servidor.invocarMetodo({
            controlador:null, //Dejarlo sin definir resultará en que se utilice el controlador principal
            componente:"archivo",
            metodo:"recibirArchivos",
            parametros:params,
            formulario:true,
            precarga:false,
            tiempo:0,
            progreso:function(p) {
                if(t.barra) t.barra.querySelector(".progreso-barra").estilos("width",Math.round(p*100)+"%");
                if(p==1) finalizarSubida();
            },
            retorno:function(ret) {
                if(ret) {
                    ret.forEach(function(clave,valor) {
                        var indice=parseInt(clave.substring(clave.indexOf("-")+1));
                        if(isNaN(indice)) return;
                        t.archivos[indice].archivo=valor;
                    });
                }
                t.procesarEvento("listo","listo");
            }
        });

        return this;
    };

    /**
     * Genera el valor de archivos.
     * @returns {componente}
     */
    this.procesarArchivos=function() {
        this.archivos=[];
        var nombres=[];

        var t=this,
            archivos=this.campo.files;
        if(archivos) archivos.forEach(function(i,archivo) {
            t.archivos.push({
                nativo:archivo,
                nombre:archivo.name,
                tamano:archivo.size,
                tipo:archivo.type,
                archivo:null,
                datos:null
            });
            nombres.push(archivo.name);
        });

        this.etiqueta.establecerHtml(nombres.join(", "));

        return this;
    };

    /**
     * Devuelve true si la carga de archivos se encuentra en curso.
     * @returns {boolean}
     */
    this.subiendo=function() {
        return this.subidaEnCurso;
    };

    /**
     * Devuelve a la función de retorno un array de objetos {nombre,datos}, donde nombre es el nombre local del archivo y datos es el contenido codificado en Base64.
     * @param {function} funcion
     * @returns {Object[]}
     */
    this.obtenerBase64=function(funcion) {
        this.procesarArchivos();
        if(this.archivos.length) {
            var promesas=[];

            this.archivos.forEach(function(archivo) {
                promesas.push(new Promise(function(resolver,rechazar) {
                    var lector=new FileReader();
                    lector.onload=(function(l,a) {
                        return function() {
                            a.datos=l.result;
                            resolver();
                        };
                    })(lector,archivo);
                    lector.readAsDataURL(archivo.nativo);
                }));
            });

            var t=this;
            Promise.all(promesas).then(function() {
                funcion(t.archivos);
            });
        }
    };

    /**
     * Actualiza el componente.
     */
    this.propiedadModificada=function(propiedad,valor,tamano,valorAnterior) {
        if(typeof valor==="undefined") valor=null;

        if(propiedad=="multiple") {
            if(valor) {
                this.campo.atributo("multiple",true);
            } else {
                this.campo.removerAtributo("multiple");
            }
            return this;
        }

        if(propiedad=="acepta") {
            this.campo.atributo("accept",valor);
            return this;
        } 
        
        if(propiedad=="multimedia") {
            if(!valor) {
                this.campo.removerAtributo("capture");
            } else {
                if(valor=="audio"||valor=="videoFrontal"||valor=="fotoFrontal") {
                    this.campo.atributo("capture","user");
                } else {
                    this.campo.atributo("capture","environment");
                }
                
                if(valor=="audio") {
                    this.campo.atributo("accept","user");
                } else if(valor=="video"||valor=="videoFrontal") {
                    this.campo.atributo("accept","video/*");
                } else if(valor=="foto"||valor=="fotoFrontal") {
                    this.campo.atributo("accept","image/*");
                }
            }
            return this;
        }

        this.propiedadModificadaComponente(propiedad,valor,tamano,valorAnterior);
        return this;
    };

    /**
     * Devuelve el valor del componente.
     * @returns {Object[]}
     */
    this.valor=function() {
        return this.archivos;
    };
};

ui.registrarComponente("archivo",componenteArchivo,configComponente.clonar({
    descripcion:"Campo de carga de archivo",
    etiqueta:"Archivo",
    grupo:"Formulario",
    icono:"archivo.png"
}));</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Externals</h3><ul><li><a href="external-EventTarget.html">EventTarget</a></li><li><a href="external-HTMLDocument.html">HTMLDocument</a></li><li><a href="external-Node.html">Node</a></li><li><a href="external-NodeList.html">NodeList</a></li><li><a href="external-Object.html">Object</a></li><li><a href="external-Window.html">Window</a></li></ul><h3>Classes</h3><ul><li><a href="ajax.html">ajax</a></li><li><a href="aplicacion.html">aplicacion</a></li><li><a href="componente.html">componente</a></li><li><a href="componenteAgenda.html">componenteAgenda</a></li><li><a href="componenteAlternar.html">componenteAlternar</a></li><li><a href="componenteArbol.html">componenteArbol</a></li><li><a href="componenteArchivo.html">componenteArchivo</a></li><li><a href="componenteBoton.html">componenteBoton</a></li><li><a href="componenteBucle.html">componenteBucle</a></li><li><a href="componenteBuscador.html">componenteBuscador</a></li><li><a href="componenteCampo.html">componenteCampo</a></li><li><a href="componenteCheckbox.html">componenteCheckbox</a></li><li><a href="componenteCodigo.html">componenteCodigo</a></li><li><a href="componenteColumna.html">componenteColumna</a></li><li><a href="componenteColumnaTabla.html">componenteColumnaTabla</a></li><li><a href="componenteCondicional.html">componenteCondicional</a></li><li><a href="componenteContenedor.html">componenteContenedor</a></li><li><a href="componenteContenedorMenu.html">componenteContenedorMenu</a></li><li><a href="componenteDeslizable.html">componenteDeslizable</a></li><li><a href="componenteDesplegable.html">componenteDesplegable</a></li><li><a href="componenteDialogo.html">componenteDialogo</a></li><li><a href="componenteEspaciador.html">componenteEspaciador</a></li><li><a href="componenteEtiqueta.html">componenteEtiqueta</a></li><li><a href="componenteFecha.html">componenteFecha</a></li><li><a href="componenteFila.html">componenteFila</a></li><li><a href="componenteFilaTabla.html">componenteFilaTabla</a></li><li><a href="componenteFormulario.html">componenteFormulario</a></li><li><a href="componenteGrupoOpciones.html">componenteGrupoOpciones</a></li><li><a href="componenteHora.html">componenteHora</a></li><li><a href="componenteIcono.html">componenteIcono</a></li><li><a href="componenteImagen.html">componenteImagen</a></li><li><a href="componenteImportar.html">componenteImportar</a></li><li><a href="componenteItemMenu.html">componenteItemMenu</a></li><li><a href="componenteMenu.html">componenteMenu</a></li><li><a href="componenteNavegacion.html">componenteNavegacion</a></li><li><a href="componentePestana.html">componentePestana</a></li><li><a href="componentePestanas.html">componentePestanas</a></li><li><a href="componenteTabla.html">componenteTabla</a></li><li><a href="componenteTexto.html">componenteTexto</a></li><li><a href="componenteVista.html">componenteVista</a></li><li><a href="controlador.html">controlador</a></li><li><a href="editable.html">editable</a></li><li><a href="enrutador.html">enrutador</a></li><li><a href="enrutadorPredeterminado.html">enrutadorPredeterminado</a></li><li><a href="expresion.html">expresion</a></li><li><a href="servidor.html">servidor</a></li><li><a href="ui.html">ui</a></li><li><a href="util.html">util</a></li></ul><h3>Global</h3><ul><li><a href="global.html#componentes">componentes</a></li><li><a href="global.html#configComponente">configComponente</a></li><li><a href="global.html#controladores">controladores</a></li><li><a href="global.html#cuerpo">cuerpo</a></li><li><a href="global.html#documento">documento</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Mon Sep 14 2020 00:39:48 GMT-0300 (GMT-03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
