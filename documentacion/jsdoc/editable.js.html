<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: editable.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: editable.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Copyright, 2020, Gabriel Quagliano. Bajo licencia Apache 2.0.
 * 
 * @author Gabriel Quagliano - gabriel.quagliano@gmail.com
 * @version 1.0
 */

 "use strict";

/**
 * @class Gestión de elementos editables (contenteditable).
 */
var editable=new function() {
    this.observador=null;

    var componentesEliminados={},
        moviendoSeleccion=false,
        moviendoNodo=null;

    this.mostrarBarra=function(elem) {
        //TODO
    };

    this.ocultarBarra=function() {
        //TODO
    };

    function insertarComponente(rango,componente) {
        var obj=null,
            nuevo=false,
            tipos=ui.obtenerComponentes();

        if(tipos.hasOwnProperty(componente)) {
            obj=ui.crearComponente(componente);
            nuevo=true;
        } else {
            obj=ui.obtenerInstanciaComponente(componente);
        }
        var elem=obj.obtenerElemento();

        //Almacenar en moviendoNodo para poder evitar eliminarlo cuando el observador detecte que se removió de su posición actual
        moviendoNodo=elem;
        try {
            rango.insertNode(elem);
        } catch { }

        obj.inicializar();

        elem.editable(false);

        if(nuevo) {
            editor.prepararComponenteInsertado(obj);
        }
    }

    function contenidoModificado(lista,o) {
        for(var p in lista) {
            if(!lista.hasOwnProperty(p)) continue;

            var item=lista[p];

            if(item.removedNodes.length) {
                //Verificar si alguno de los nodos eliminados correspondía a un componente
                for(var i=0;i&lt;item.removedNodes.length;i++) {
                    var nodo=item.removedNodes[i];
                    if(nodo==moviendoNodo||!util.esElemento(nodo)) continue;
                    var id=nodo.dato("fxid");
                    if(!id) continue;

                    //Eliminar componente
                    var comp=ui.obtenerInstanciaComponente(id);
                    if(comp) comp.eliminar();
                }

                //Evitar que se elimine todo el texto del componente
                if(!item.target.childNodes.length||(item.target.childNodes.length==1&amp;&amp;item.target.childNodes[0].es({clase:"foxtrot-etiqueta-componente"}))) {
                    item.target.anexar("&amp;nbsp;");
                }
            }

            if(item.addedNodes.length) {
                //Verificar si alguno de los nodos insertados corresponde a un componente
                for(var i=0;i&lt;item.addedNodes.length;i++) {
                    var nodo=item.addedNodes[i];
                    if(nodo==moviendoNodo||!util.esElemento(nodo)) continue;
                    var id=nodo.dato("fxid");
                    if(!id) continue;

                    //TODO Restaurar componente (fue eliminado previamente, no se lo podemos pedir a ui)
                    //TODO Creo que sería mejor implementar un historial (ctrl-z/ctrl-y) propio
                }                
            }
        }
    }

    function onDrop(e) {        
        e.stopPropagation();

        if(moviendoSeleccion) {
            moviendoSeleccion=false;
            return;
        }
        moviendoSeleccion=false;

        //Identificar el tipo de contenido
        var datos=e.dataTransfer.getData("text/plain"),
            obj=null,
            comp=null,
            insertar=null;

        try { obj=JSON.parse(datos); } catch {}
        
        if(obj) {
            if(obj.hasOwnProperty("insertarComponente")) {
                //Nuevo componente
                comp=obj.insertarComponente;
            } else if(obj.hasOwnProperty("idComponente")) {
                //Moviendo componente
                comp=obj.idComponente;
            } else {
                //Tratar el json como texto
                insertar=datos;
            }
        //} else if(!datos&amp;&amp;html!="") {
        //    //Extraer el texto
        //    insertar=document.crear("&lt;div>").establecerHtml(html).texto();
        } else if(datos) {
            //TODO Intentar insertar como imagen
            //TODO Insertar link si es una url
            //TODO Archivos

            insertar=datos;
        } else {
            //Otros (ignorar)
            e.preventDefault();
            return;
        }

        e.preventDefault();

        var doc=ui.obtenerDocumento();        

        //Crear el cursor en la posición en la cual se soltó el contenido
        var rango,seleccion;
        if(doc.caretRangeFromPoint) {
            rango=doc.caretRangeFromPoint(e.clientX,e.clientY);
        } else if(e.rangeParent) {
            rango=doc.createRange();
            rango.setStart(e.rangeParent,e.rangeOffset);
        }
        e.target.focus();
        seleccion=doc.getSelection();
        seleccion.removeAllRanges(); 
        seleccion.addRange(rango);

        //Insertar en el cursor
        if(comp) {
            insertarComponente(rango,comp);
        } else if(typeof insertar==="string") {
            doc.execCommand("insertText",false,insertar);
        }
        seleccion.removeAllRanges();
    }

    /**
     * Establece la propiedad contentEditable.
     */
    Node.prototype.editable=function(estado) {
        if(util.esIndefinido(estado)) estado=true;
        this.propiedad("contentEditable",estado);

        //TODO controles de formato

        return this;
    };

    function onFocus() {
        editable.mostrarBarra(this);
    }

    function onBlur() {
        editable.ocultarBarra();
    }

    function dragStart(e) {
        //Detectar si se está moviendo el texto seleccionado
        if(e.target.nodeType==Node.TEXT_NODE) moviendoSeleccion=true;
        //Evitar que al arrastrar se arrastre el elemento completo o alguno de sus padres
        e.stopPropagation();
    }

    function keyDown(e) {
        if(e.which==46) { //DEL
            //Evitar que se elimine el componente
            e.stopPropagation();
        }
    }
    
    /**
     * Activa el modo de edición.
     */
    Node.prototype.iniciarEdicion=function() {
        this.editable(true);

        var t=this,
            f=function(e) {
                e.stopPropagation();
            };

        //Crear un destino especial que permita soltar algunos componentes (etiqueta, imagen) como así también contenido como texto e imágenes
        this.crearDestino({
            drop:onDrop,
            dragenter:f,
            dragleave:f,
            dragover:f
        });

        //TODO Pegar componentes y contenido externo (texto, imágenes)

        this.evento("focus",onFocus)
            .evento("blur",onBlur)
            .evento("dragstart",dragStart)
            .evento("keydown",keyDown);

        //Escuchar cambios para detectar cuando se elimina/reestablece (ctrl+z) contenido que corresponde a un componente hijo
        this.observador=new MutationObserver(contenidoModificado);
        this.observador.observe(this,{
            childList:true,
            subtree:true
        });

        //TODO Limpieza del html generado
        
        return this;
    };

    /**
     * Desactiva el modo de edición.
     */
    Node.prototype.finalizarEdicion=function() {
        this.editable(false);

        //Remover eventos
        this.removerDestino()
            .removerEvento("focus",onFocus)
            .removerEvento("blur",onBlur)
            .removerEvento("dragstart",dragStart);

        this.observador.disconnect();         
        return this;
    };
};

window["editable"]=editable;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ajax.html">ajax</a></li><li><a href="aplicacion.html">aplicacion</a></li><li><a href="componente.html">componente</a></li><li><a href="componenteAgenda.html">componenteAgenda</a></li><li><a href="componenteAlternar.html">componenteAlternar</a></li><li><a href="componenteArbol.html">componenteArbol</a></li><li><a href="componenteArchivo.html">componenteArchivo</a></li><li><a href="componenteBoton.html">componenteBoton</a></li><li><a href="componenteBucle.html">componenteBucle</a></li><li><a href="componenteBuscador.html">componenteBuscador</a></li><li><a href="componenteCampo.html">componenteCampo</a></li><li><a href="componenteCheckbox.html">componenteCheckbox</a></li><li><a href="componenteCodigo.html">componenteCodigo</a></li><li><a href="componenteColumna.html">componenteColumna</a></li><li><a href="componenteColumnaTabla.html">componenteColumnaTabla</a></li><li><a href="componenteCondicional.html">componenteCondicional</a></li><li><a href="componenteContenedor.html">componenteContenedor</a></li><li><a href="componenteContenedorMenu.html">componenteContenedorMenu</a></li><li><a href="componenteDeslizable.html">componenteDeslizable</a></li><li><a href="componenteDesplegable.html">componenteDesplegable</a></li><li><a href="componenteDialogo.html">componenteDialogo</a></li><li><a href="componenteEspaciador.html">componenteEspaciador</a></li><li><a href="componenteEtiqueta.html">componenteEtiqueta</a></li><li><a href="componenteFecha.html">componenteFecha</a></li><li><a href="componenteFila.html">componenteFila</a></li><li><a href="componenteFilaTabla.html">componenteFilaTabla</a></li><li><a href="componenteFormulario.html">componenteFormulario</a></li><li><a href="componenteGrupoOpciones.html">componenteGrupoOpciones</a></li><li><a href="componenteHora.html">componenteHora</a></li><li><a href="componenteIcono.html">componenteIcono</a></li><li><a href="componenteImagen.html">componenteImagen</a></li><li><a href="componenteImportar.html">componenteImportar</a></li><li><a href="componenteItemMenu.html">componenteItemMenu</a></li><li><a href="componenteMenu.html">componenteMenu</a></li><li><a href="componenteNavegacion.html">componenteNavegacion</a></li><li><a href="componentePestana.html">componentePestana</a></li><li><a href="componentePestanas.html">componentePestanas</a></li><li><a href="componenteTabla.html">componenteTabla</a></li><li><a href="componenteTexto.html">componenteTexto</a></li><li><a href="componenteVista.html">componenteVista</a></li><li><a href="controlador.html">controlador</a></li><li><a href="editable.html">editable</a></li><li><a href="enrutador.html">enrutador</a></li><li><a href="enrutadorPredeterminado.html">enrutadorPredeterminado</a></li><li><a href="expresion.html">expresion</a></li><li><a href="servidor.html">servidor</a></li><li><a href="ui.html">ui</a></li><li><a href="util.html">util</a></li></ul><h3>Global</h3><ul><li><a href="global.html#componentes">componentes</a></li><li><a href="global.html#configComponente">configComponente</a></li><li><a href="global.html#controladores">controladores</a></li><li><a href="global.html#duracionAnimacion">duracionAnimacion</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Sun Sep 13 2020 11:31:03 GMT-0300 (GMT-03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
