<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: arrastra.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: arrastra.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Copyright, 2020, Gabriel Quagliano. Bajo licencia Apache 2.0.
 * 
 * @author Gabriel Quagliano - gabriel.quagliano@gmail.com
 * @version 1.0
 */

 /**
 * Gestor de eventos de arrastrar y soltar (drag and drop), ideado para abastraer el acceso al mismo para abreviar el código y simplificar
 * la resolución de cualquier incompatibilidad entre navegadores, pero implementando las funciones HTML5 nativas.
 */
(function() {
    "use strict";

    var opcionesArrastre={},
        opcionesDestinos={};

    Node.prototype.removerArrastre=function() {
        var id=this.obtenerId();
        if(!opcionesArrastre.hasOwnProperty(id)) return this;
        var opciones=opcionesArrastre[id];

        var arrastrable=this;
        if(typeof opciones.asa==="string") {
            arrastrable=elem.querySelector(opciones.asa);
        } else if(util.esElemento(opciones.asa)) {
            arrastrable=opciones.asa;
        }

        arrastrable.propiedad("draggable",false)
            .removerAtributo("draggable")
            .removerClase("foxtrot-arrastrable-arrastrable")
            .metadato("arrastra",null)
            .removerEvento("dragstart drag dragend");

        delete opcionesArrastre[this.obtenerId()];

        return this;
    };

    Node.prototype.removerDestino=function() {
        var id=this.obtenerId();
        if(!opcionesDestinos.hasOwnProperty(id)) return this;
        delete opcionesDestinos[id];
        this.removerClase("foxtrot-arrastrable-destino")
            .removerEvento("dragenter dragover dragleave drop");
        return this;
    };

    function dragStart(e) {
        var elem=this.metadato("arrastra"),
            opciones=opcionesArrastre[elem.obtenerId()];
            
        //Detener la propagación permitirá arrastrables anidados
        e.stopPropagation();

        elem.agregarClase("foxtrot-arrastrable-arrastrando");
        
        if(opciones.icono) {
            var ic=opciones.icono;
            if(!util.esElemento(ic)) ic=document.crear("&lt;img>").atributo("src",ic).obtener(0);
            e.dataTransfer.setDragImage(ic,-15,-15);
        }
        
        if(opciones.datos) {
            e.dataTransfer.setData("text/plain",opciones.datos);
        }
    }
    
    function dragEnd(e) {
        var opciones=opcionesArrastre[this.obtenerId()];

        this.removerClase("foxtrot-arrastrable-arrastrando");
        
        //Limpiar también todos los destinos
        var a="foxtrot-arrastrable-arrastrando-sobre";
        document.querySelectorAll("."+a).removerClase(a);
        if(typeof ui!=="undefined") ui.obtenerDocumento().querySelectorAll("."+a).removerClase(a);
    }

    function dragEnter(e) {
        var opciones=opcionesDestinos[this.obtenerId()];

        //TODO Determinar si se acepta el elemento que se está arrastrando
        
        this.agregarClase("foxtrot-arrastrable-arrastrando-sobre");
    }

    function dragOver(e) {
        var opciones=opcionesDestinos[this.obtenerId()];

        //TODO Determinar si se acepta el elemento que se está arrastrando
    
        //Si no se invoca preventDefault, no recibirá ninguna operación
        e.preventDefault();
        
        e.dataTransfer.dropEffect="move";     
    }

    function dragLeave(e) {
        var opciones=opcionesDestinos[this.obtenerId()];
        this.removerClase("foxtrot-arrastrable-arrastrando-sobre");        
    }

    function drop(e) {
        var opciones=opcionesDestinos[this.obtenerId()];

        //TODO Determinar si se acepta el elemento que se está soltando (y comunicar de alguna manera a los otros listeners de drop)
        
        this.removerClase("foxtrot-arrastrable-arrastrando-sobre");
    }

    /**
     * Hace a los elementos arrastrables. Establecer opciones=false para deshabilitar.
     */
    Node.prototype.arrastrable=function(opciones) {
        if(util.esIndefinido(opciones)) opciones={};
        var predeterminados={
            //Mantenemos los nombres de eventos en inglés
            dragstart:null,
            drag:null,
            dragend:null,
            asa:null,
            icono:null,
            mover:false,
            limite:null,
            datos:null,
            pausado:false
        };
        opciones=Object.assign(predeterminados,opciones);

        if(opciones.mover) {
            //Implementación automática del reposicionamiento del elemento (como una ventana o un diálogo)            
            if(opciones.dragstart) {
                opciones.dragstart=[opciones.dragstart,moverDragstart];
            } else {
                opciones.dragstart=moverDragstart;
            }
            if(opciones.drag) {
                opciones.drag=[opciones.drag,moverDrag];
            } else {
                opciones.drag=moverDrag;
            }
            if(opciones.dragend) {
                opciones.dragend=[opciones.dragend,moverDragend];
            } else {
                opciones.dragend=moverDragend;
            }
            if(!opciones.limite) opciones.limite=window;
        }

        var elem=this;

        this.removerArrastre();
        
        opcionesArrastre[elem.obtenerId()]=opciones;

        var arrastrable=elem;
        if(typeof opciones.asa==="string") {
            arrastrable=elem.querySelector(opciones.asa);
        } else if(util.esElemento(opciones.asa)) {
            arrastrable=opciones.asa;
        }

        arrastrable.propiedad("draggable",true)
            .agregarClase("foxtrot-arrastrable-arrastrable");

        arrastrable.metadato("arrastra",elem);

        if(opciones.dragstart) arrastrable.evento("dragstart",opciones.dragstart);
        if(opciones.drag) arrastrable.evento("drag",opciones.drag);
        if(opciones.dragend) arrastrable.evento("dragend",opciones.dragend);

        arrastrable.evento("dragstart",dragStart)
            .evento("dragend",dragEnd);

        return this;
    };

    /**
     * Hace que los elementos admitan que se suelte otro elemento dentro de sí. Establecer opciones=false para deshabilitar. 
     */
    Node.prototype.crearDestino=function(opciones) {
        if(util.esIndefinido(opciones)) opciones={};
        var predeterminados={
            //Mantenemos los nombres de eventos en inglés
            dragenter:null,
            dragover:null,
            dragleave:null,
            drop:null,
            pausado:false
        };
        opciones=Object.assign(predeterminados,opciones);

        var elem=this;

        this.removerDestino();
        
        opcionesDestinos[elem.obtenerId()]=opciones;
        
        elem.agregarClase("foxtrot-arrastrable-destino");

        if(opciones.dragenter) elem.evento("dragenter",opciones.dragenter);
        if(opciones.dragover) elem.evento("dragover",opciones.dragover);
        if(opciones.dragleave) elem.evento("dragleave",opciones.dragleave);
        if(opciones.drop) elem.evento("drop",opciones.drop);

        elem.evento("dragenter",dragEnter)
            .evento("dragover",dragOver)
            .evento("dragleave",dragLeave)
            .evento("drop",drop);

        return this;
    };

    /**
     * Hace que los elementos acepten arrastrar y soltar archivos desde el escritorio del cliente sobre ellos. Establecer opciones=false para deshabilitar.
     */
    Node.prototype.crearDestinoArchivo=function(opciones) {


        return this;
    };

    /**
     * Detiene momentáneamente o reestablece las operaciones de arrastre para el elemento.
     */
    Node.prototype.pausarArrastre=function(pausar) {
        if(util.esIndefinido(pausar)) pausar=true;

        //Verificar que sea un arrastrable, de esta forma el cliente puede llamar pausarArrastre() en cualquier elemento sin verificarlo por su cuenta

        var id=this.obtenerId();

        if(opcionesArrastre.hasOwnProperty(id)&amp;&amp;opcionesArrastre[id].pausado!=pausar) {
            var opciones=opcionesArrastre[id],
                arrastrable=this.metadato("arrastra");

            opciones.pausado=pausar;

            if(pausar) {
                //Almacenar los listeners que vamos a remover para poder reestablecerlos luego
                opciones._eventosPausados_dragstart=arrastrable.evento("dragstart");

                arrastrable.propiedad("draggable",false)
                    .removerAtributo("draggable")
                    .removerClase("foxtrot-arrastrable-arrastrable")
                    .removerEvento("dragstart");
            } else {
                arrastrable.propiedad("draggable",true)
                    .agregarClase("foxtrot-arrastrable-arrastrable")
                    .evento("dragstart",opciones._eventosPausados_dragstart);
            }
        }

        if(opcionesDestinos.hasOwnProperty(id)&amp;&amp;opcionesDestinos[id].pausado!=pausar) {
            var opciones=opcionesDestinos[id];

            opciones.pausado=pausar;

            if(pausar) {
                //Almacenar los listeners que vamos a remover para poder reestablecerlos luego
                opciones._eventosPausados_dragenter=this.evento("dragenter");
                opciones._eventosPausados_dragover=this.evento("dragover");
                opciones._eventosPausados_drop=this.evento("drop");
                
                this.removerClase("foxtrot-arrastrable-destino")
                    .removerEvento("dragenter")
                    .removerEvento("dragover")
                    .removerEvento("drop");
            } else {
                this.agregarClase("foxtrot-arrastrable-destino")
                    .evento("dragenter",opciones._eventosPausados_dragenter)
                    .evento("dragover",opciones._eventosPausados_dragover)
                    .evento("drop",opciones._eventosPausados_drop);
            }
        }

        return this;
    };

    /**
     * Aplica pausarArrastre(estado) en el elemento y toda su ascendencia.
     */
    Node.prototype.pausarArrastreArbol=function(estado) {
        var elem=this;
        while(elem!==null&amp;&amp;elem.nodeName!="BODY") { //Parar al llegar a &lt;body>
            elem.pausarArrastre(estado);
            elem=elem.padre();
        }
        return this;
    };

    //Implementación automática de arrastre
    
    var moverX,moverY;

    function moverDragover(e) {
        e=(e||event);
        e.preventDefault();
        //e.stopPropagation();
        e.dataTransfer.dropEffect="move";
    }

    function moverDragstart(e) {
        e=e||event;
        moverX=e.clientX;
        moverY=e.clientY;

        //Remover el elemento "fantasma"
        e.dataTransfer.setDragImage(new Image,0,0);
        //Implementar dragover en el documento para controlar el cursor
        document.evento("dragover",moverDragover);
    }

    function moverDrag(e) {
        e=e||event;
        if(e.clientX==0&amp;&amp;e.clientY==0) return;
        
        var elem=this.metadato("arrastra"),
            dx=e.clientX-moverX,
            dy=e.clientY-moverY;
        moverX=e.clientX;
        moverY=e.clientY;

        var pos=elem.posicionEstilos(),
            ancho=elem.ancho(),
            alto=elem.alto(),
            anchoVentana=window.ancho(),
            altoVentana=window.alto();

        if(pos.x+dx&lt;=0||pos.y+dy&lt;=0||pos.x+dx+ancho>=anchoVentana||pos.y+dy+alto>=altoVentana) {
            //Fuera de los límites
            return;
        }

        elem.estilos({
            left:pos.left+dx,
            top:pos.top+dy,
            //Cambiamos el posicionamiento de right a left y bottom a top 
            //TODO Poder configurar este comportamiento
            right:"auto",
            bottom:"auto"
        });
    }

    function moverDragend(e) {
        document.removerEvento("dragover",moverDragover);
    }
})();

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Externals</h3><ul><li><a href="external-EventTarget.html">EventTarget</a></li><li><a href="external-HTMLDocument.html">HTMLDocument</a></li><li><a href="external-Node.html">Node</a></li><li><a href="external-NodeList.html">NodeList</a></li><li><a href="external-Object.html">Object</a></li><li><a href="external-Window.html">Window</a></li></ul><h3>Classes</h3><ul><li><a href="ajax.html">ajax</a></li><li><a href="aplicacion.html">aplicacion</a></li><li><a href="componente.html">componente</a></li><li><a href="componenteAgenda.html">componenteAgenda</a></li><li><a href="componenteAlternar.html">componenteAlternar</a></li><li><a href="componenteArbol.html">componenteArbol</a></li><li><a href="componenteArchivo.html">componenteArchivo</a></li><li><a href="componenteBoton.html">componenteBoton</a></li><li><a href="componenteBucle.html">componenteBucle</a></li><li><a href="componenteBuscador.html">componenteBuscador</a></li><li><a href="componenteCampo.html">componenteCampo</a></li><li><a href="componenteCheckbox.html">componenteCheckbox</a></li><li><a href="componenteCodigo.html">componenteCodigo</a></li><li><a href="componenteColumna.html">componenteColumna</a></li><li><a href="componenteColumnaTabla.html">componenteColumnaTabla</a></li><li><a href="componenteCondicional.html">componenteCondicional</a></li><li><a href="componenteContenedor.html">componenteContenedor</a></li><li><a href="componenteContenedorMenu.html">componenteContenedorMenu</a></li><li><a href="componenteDeslizable.html">componenteDeslizable</a></li><li><a href="componenteDesplegable.html">componenteDesplegable</a></li><li><a href="componenteDialogo.html">componenteDialogo</a></li><li><a href="componenteEspaciador.html">componenteEspaciador</a></li><li><a href="componenteEtiqueta.html">componenteEtiqueta</a></li><li><a href="componenteFecha.html">componenteFecha</a></li><li><a href="componenteFila.html">componenteFila</a></li><li><a href="componenteFilaTabla.html">componenteFilaTabla</a></li><li><a href="componenteFormulario.html">componenteFormulario</a></li><li><a href="componenteGrupoOpciones.html">componenteGrupoOpciones</a></li><li><a href="componenteHora.html">componenteHora</a></li><li><a href="componenteIcono.html">componenteIcono</a></li><li><a href="componenteImagen.html">componenteImagen</a></li><li><a href="componenteImportar.html">componenteImportar</a></li><li><a href="componenteItemMenu.html">componenteItemMenu</a></li><li><a href="componenteMenu.html">componenteMenu</a></li><li><a href="componenteNavegacion.html">componenteNavegacion</a></li><li><a href="componentePestana.html">componentePestana</a></li><li><a href="componentePestanas.html">componentePestanas</a></li><li><a href="componenteTabla.html">componenteTabla</a></li><li><a href="componenteTexto.html">componenteTexto</a></li><li><a href="componenteVista.html">componenteVista</a></li><li><a href="controlador.html">controlador</a></li><li><a href="editable.html">editable</a></li><li><a href="enrutador.html">enrutador</a></li><li><a href="enrutadorPredeterminado.html">enrutadorPredeterminado</a></li><li><a href="expresion.html">expresion</a></li><li><a href="servidor.html">servidor</a></li><li><a href="ui.html">ui</a></li><li><a href="util.html">util</a></li></ul><h3>Global</h3><ul><li><a href="global.html#componentes">componentes</a></li><li><a href="global.html#configComponente">configComponente</a></li><li><a href="global.html#controladores">controladores</a></li><li><a href="global.html#cuerpo">cuerpo</a></li><li><a href="global.html#documento">documento</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Sun Sep 13 2020 18:20:58 GMT-0300 (GMT-03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
